import { useState, useEffect } from 'react'
import { motion, AnimatePresence } from 'framer-motion'
import { Link, useNavigate } from 'react-router-dom'
import { useProgress } from '../../hooks/useProgress'
import {
  Search,
  Bell,
  Plus,
  FolderKanban,
  CheckCircle2,
  Loader2,
  Clock3,
  TrendingUp,
  CalendarDays,
  Users,
  Award,
  Wallet,
  HeartPulse,
  Target,
  Rocket,
  Briefcase
} from 'lucide-react'

const PRIMARY = '#1F4E79'
const SECONDARY = '#37A6FF'
const HIGHLIGHT = '#FFB600'

export default function OverviewPage() {
  const navigate = useNavigate()
  const [showLevels, setShowLevels] = useState(false)
  const LEVELS = Array.from({ length: 20 }, (_, i) => ({
    id: i + 1,
    name: `Level ${i + 1}`,
    color: [
      '#0ea5e9','#22c55e','#f59e0b','#ef4444','#8b5cf6',
      '#06b6d4','#84cc16','#f97316','#e11d48','#14b8a6',
      '#2563eb','#16a34a','#fbbf24','#dc2626','#7c3aed',
      '#0891b2','#65a30d','#fb923c','#be123c','#0d9488'
    ][i]
  }))
  // Get user progress data
  const { progress, loading } = useProgress()

  const metrics = [
    { id: 'total', label: 'Total Projects', value: progress?.projects.total ?? 0, icon: FolderKanban, accent: 'from-[#1F4E79] to-[#37A6FF]' },
    { id: 'ended', label: 'Completed Projects', value: progress?.projects.completed ?? 0, icon: CheckCircle2, accent: 'from-[#16A34A] to-[#86EFAC]' },
    { id: 'running', label: 'Active Projects', value: progress?.projects.active ?? 0, icon: Loader2, accent: 'from-[#37A6FF] to-[#60A5FA]' },
    { id: 'pending', label: 'Pending Projects', value: progress?.projects.pending ?? 0, icon: Clock3, accent: 'from-[#F43F5E] to-[#FDA4AF]' },
  ]

  const [reminders, setReminders] = useState([])

  useEffect(() => {
    // Fetch reminders
    const fetchReminders = async () => {
      if (!progress) return
      const data = await progress.getReminders()
      setReminders(data)
    }
    fetchReminders()
  }, [progress])

  const team = [
    { id: 'u1', name: 'Alexandra Deff', role: 'GitHub Repo', avatar: 'ðŸ§‘â€ðŸ’»' },
    { id: 'u2', name: 'Edwin Adenike', role: 'Auth System', avatar: 'ðŸ›¡ï¸' },
    { id: 'u3', name: 'Isaac Oluwatemilorun', role: 'Search & Filters', avatar: 'ðŸ”' },
    { id: 'u4', name: 'David Oshodi', role: 'Responsive Layout', avatar: 'ðŸ“±' },
  ]

  const kpiCard = (m: typeof metrics[number]) => (
    <div key={m.id} className="bg-white rounded-xl shadow-[0_4px_12px_rgba(0,0,0,0.05)] p-5 border border-gray-100">
      <div className="flex items-center justify-between">
        <div>
          <div className="text-sm text-gray-600">{m.label}</div>
          <div className="mt-1 text-3xl font-extrabold text-[#1F4E79]">{m.value}</div>
        </div>
        <div className={`w-12 h-12 rounded-lg bg-gradient-to-br ${m.accent} flex items-center justify-center text-white`}>
          <m.icon className="w-6 h-6" />
        </div>
      </div>
      {loading ? (
        <div className="mt-2 text-xs text-gray-400">Loading...</div>
      ) : (
        <div className="mt-2 text-xs text-neutral-600">
          {progress?.history
            .filter(h => h.metric === `projects_${m.id}`)
            .slice(-1)
            .map(h => (
              h.change > 0 
                ? <span className="text-green-600">{h.change}â†‘ from last update</span>
                : <span className="text-neutral-500">No recent changes</span>
            ))
          }
        </div>
      )}
    </div>
  )

  return (
    <div className="min-h-full bg-[#FAFAFA] p-6 lg:p-8">
      {/* Top bar inside main area */}
      <div className="mb-8 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div className="flex-1 flex items-center gap-3">
          <div className="relative w-full md:max-w-md">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" />
            <input placeholder="Searchâ€¦" className="w-full pl-10 pr-3 py-2 rounded-lg border-2 border-gray-200 focus:border-[#37A6FF] outline-none bg-white" />
          </div>
        </div>
        <div className="flex items-center gap-3">
          <button onClick={() => navigate('/dashboard/projects?create=1')} className="px-4 py-2 rounded-lg bg-[#37A6FF] text-white font-semibold inline-flex items-center gap-2">
            <Plus className="w-4 h-4" />
            Add Project
          </button>
          <button onClick={() => navigate('/dashboard/notifications')} className="p-2 rounded-lg bg-white border-2 border-gray-200">
            <Bell className="w-5 h-5 text-[#1F4E79]" />
          </button>
          <Link to="/dashboard/profile" className="w-9 h-9 rounded-full bg-[#37A6FF] text-white font-bold grid place-items-center">A</Link>
          <button 
            onClick={() => setShowLevels(true)} 
            className="hidden md:flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-[#FFD700]/20 to-[#FFA500]/20 rounded-full border-2 border-[#FFD700]/30"
            title={`Experience: ${progress?.experience ?? 0}/${progress?.nextLevelXp ?? 1000} XP`}
          >
            <Award className="w-5 h-5 text-[#FFA500]" />
            <span className="font-semibold text-[#1F4E79]">Level {progress?.level ?? 1}</span>
          </button>
        </div>
      </div>

      {/* KPI row */}
      <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
        {metrics.map(kpiCard)}
      </div>

      {/* Analytics & Progress */}
      <div className="mt-10 grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Project Analytics mini-bars */}
        <div className="bg-white rounded-xl shadow-[0_4px_12px_rgba(0,0,0,0.05)] p-5 border border-gray-100">
          <div className="font-bold text-[#1F4E79] mb-3">Project Analytics</div>
          <div className="grid grid-cols-7 gap-3 items-end h-36">
            {['S','M','T','W','T','F','S'].map((d, i) => (
              <div key={d} className="flex flex-col items-center gap-2">
                <div className="w-full rounded-lg bg-gradient-to-t from-[#E5E7EB] to-[#E5E7EB]">
                  <div className="w-full rounded-lg" style={{ height: `${20 + i*8}%`, background: `linear-gradient(180deg, ${SECONDARY}, ${PRIMARY})` }} />
                </div>
                <div className="text-xs text-gray-500">{d}</div>
              </div>
            ))}
          </div>
        </div>

        {/* Progress Donut */}
        <div className="bg-white rounded-xl shadow-[0_4px_12px_rgba(0,0,0,0.05)] p-5 border border-gray-100 flex items-center justify-center">
          <div className="text-center">
            <div className="relative w-48 h-48 mx-auto">
              <div className="absolute inset-0 rounded-full" style={{ background: `conic-gradient(${SECONDARY} 0 41%, #E5E7EB 41% 100%)` }} />
              <div className="absolute inset-3 rounded-full bg-white grid place-items-center">
                <div>
                  <div className="text-3xl font-extrabold text-[#1F4E79]">41%</div>
                  <div className="text-xs text-gray-500">Project Ended</div>
                </div>
              </div>
            </div>
            <div className="mt-4 flex items-center justify-center gap-4 text-xs">
              <span className="inline-flex items-center gap-1"><span className="w-3 h-3 rounded-full" style={{ background: SECONDARY }} /> Completed</span>
              <span className="inline-flex items-center gap-1"><span className="w-3 h-3 rounded-full bg-[#FFEDD5]" /> In Progress</span>
              <span className="inline-flex items-center gap-1"><span className="w-3 h-3 rounded-full" style={{ background: HIGHLIGHT }} /> Pending</span>
            </div>
          </div>
        </div>

        {/* Reminders */}
        <div className="bg-white rounded-xl shadow-[0_4px_12px_rgba(0,0,0,0.05)] p-5 border border-gray-100">
          <div className="font-bold text-[#1F4E79] mb-3">Reminders</div>
          <ul className="space-y-3">
            {quickReminders.map(r => (
              <li key={r.id} className="flex items-center justify-between p-3 rounded-lg border-2 border-gray-100">
                <div>
                  <div className="font-medium text-[#1F4E79]">{r.title}</div>
                  <div className="text-xs text-gray-500">{r.time}</div>
                </div>
                <button className="px-3 py-1.5 rounded-lg bg-[#1F4E79] text-white text-xs">Start</button>
              </li>
            ))}
          </ul>
        </div>
      </div>

      {/* Modules overview row */}
      <div className="mt-10 grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-6">
        {[
          { title: 'Skills', route: '/dashboard/skills', icon: Award, accent: 'text-[#1F4E79] bg-[#EAF7FF]', value: '3 badges', sub: '+1 this week' },
          { title: 'Budget', route: '/dashboard/budget', icon: Wallet, accent: 'text-[#1F4E79] bg-[#FFF7E6]', value: '$450 left', sub: 'of $1,000' },
          { title: 'Well-being', route: '/dashboard/wellbeing', icon: HeartPulse, accent: 'text-[#1F4E79] bg-[#EAFBF4]', value: 'Streak 5', sub: 'Keep it up!' },
          { title: 'Focus', route: '/dashboard/focus', icon: Target, accent: 'text-[#1F4E79] bg-[#F0F5FF]', value: '12h focused', sub: 'This week' },
          { title: 'Career', route: '/dashboard/career', icon: Rocket, accent: 'text-[#1F4E79] bg-[#F5F3FF]', value: '2 interviews', sub: 'Scheduled' },
          { title: 'Community', route: '/dashboard/community', icon: Users, accent: 'text-[#1F4E79] bg-[#F0FFF4]', value: '8 new posts', sub: 'Today' },
          { title: 'Projects', route: '/dashboard/projects', icon: FolderKanban, accent: 'text-[#1F4E79] bg-[#EAF7FF]', value: '4 due soon', sub: 'Next 7 days' },
          { title: 'Internships', route: '/dashboard/internships', icon: Briefcase, accent: 'text-[#1F4E79] bg-[#E6F4FF]', value: '6 matches', sub: 'Based on profile' },
        ].map(card => (
          <div key={card.title} className="bg-white rounded-xl shadow-[0_4px_12px_rgba(0,0,0,0.05)] p-5 border border-gray-100">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-sm text-gray-600">{card.title}</div>
                <div className="mt-1 text-2xl font-extrabold text-[#1F4E79]">{card.value}</div>
                <div className="text-xs text-gray-500">{card.sub}</div>
              </div>
              <div className={`w-10 h-10 rounded-lg grid place-items-center ${card.accent}`}>
                <card.icon className="w-5 h-5" />
              </div>
            </div>
            <Link to={card.route} className="mt-4 inline-flex items-center gap-2 text-sm text-[#1F4E79] font-semibold underline">Open</Link>
          </div>
        ))}
      </div>

      {/* Lists row */}
      <div className="mt-10 grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Team Collaboration */}
        <div className="lg:col-span-2 bg-white rounded-xl shadow-[0_4px_12px_rgba(0,0,0,0.05)] p-5 border border-gray-100">
          <div className="font-bold text-[#1F4E79] mb-3 flex items-center gap-2"><Users className="w-5 h-5" /> Team Collaboration</div>
          <ul className="divide-y divide-gray-100">
            {team.map(member => (
              <li key={member.id} className="py-3 flex items-center gap-3">
                <div className="w-10 h-10 rounded-full bg-[#EAF7FF] grid place-items-center text-xl">{member.avatar}</div>
                <div className="flex-1">
                  <div className="font-medium text-[#1F4E79]">{member.name}</div>
                  <div className="text-xs text-gray-500">Working on {member.role}</div>
                </div>
                <button className="px-3 py-1.5 rounded-lg border-2 border-gray-200 text-xs">Message</button>
              </li>
            ))}
          </ul>
        </div>

        {/* Project Progress small list */}
        <div className="bg-white rounded-xl shadow-[0_4px_12px_rgba(0,0,0,0.05)] p-5 border border-gray-100">
          <div className="font-bold text-[#1F4E79] mb-3">Upcoming Projects</div>
          <ul className="space-y-3 text-sm">
            {[
              { name: 'Develop API Endpoints', due: 'Nov 26, 2025' },
              { name: 'Build Dashboard', due: 'Nov 30, 2025' },
              { name: 'Optimize Page Load', due: 'Dec 5, 2025' },
            ].map((p) => (
              <li key={p.name} className="flex items-center justify-between p-3 rounded-lg border-2 border-gray-100">
                <span className="text-[#1F4E79] font-medium">{p.name}</span>
                <span className="text-xs text-gray-500">{p.due}</span>
              </li>
            ))}
          </ul>
        </div>
      </div>

      {/* Levels modal */}
      <AnimatePresence>
        {showLevels && (
          <>
            <motion.div onClick={() => setShowLevels(false)} className="fixed inset-0 bg-black/50 z-40" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }} />
            <motion.div className="fixed inset-0 z-50 flex items-center justify-center p-4" initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, y: 20 }}>
              <div className="w-full max-w-2xl bg-white rounded-2xl shadow-2xl p-6">
                <div className="flex items-center justify-between mb-3">
                  <div className="font-bold text-[#1F4E79] text-xl">Levels & How to Earn</div>
                  <button onClick={() => setShowLevels(false)} className="px-3 py-1.5 border-2 rounded-lg">Close</button>
                </div>
                <p className="text-sm text-gray-600 mb-4">Earn points by completing focus sessions, finishing project tasks, logging well-being check-ins, and applying to internships. Level up as you gain points.</p>
                <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                  {LEVELS.map(l => (
                    <div key={l.id} className="p-3 rounded-xl border-2 border-gray-100 flex items-center justify-between">
                      <span className="font-semibold text-[#1F4E79]">{l.name}</span>
                      <span className="w-4 h-4 rounded-full" style={{ background: l.color }} />
                    </div>
                  ))}
                </div>
                <div className="mt-4 text-sm text-gray-700">
                  <ul className="list-disc ml-5 space-y-1">
                    <li>Focus session completed: +50 to +100 points</li>
                    <li>Project task completed: +20 points</li>
                    <li>Daily well-being check-in: +10 points</li>
                    <li>Internship application submitted: +25 points</li>
                  </ul>
                </div>
              </div>
            </motion.div>
          </>
        )}
      </AnimatePresence>
    </div>
  )
}
